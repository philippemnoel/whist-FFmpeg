# workflows/build-and-publish.yml
#
# Build & Publish Fractal FFmpeg
# Build and publish the internal Fractal version of FFmpeg.

name: "Build & Publish Fractal FFmpeg"

on:
  push:
    branches: [master, phil/ci]
    paths-ignore:
      - "README.md"
  workflow_dispatch:

jobs:
  build-and-publish-fractal-ffmpeg:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}

    # Platforms to build on/for
    strategy:
      matrix:
        config:
          - name: "Build and Publish Fractal FFmpeg on Windows"
            os: windows-2016
          - name: "Build and Publish Fractal FFmpeg on macOS"
            os: macos-10.14 # Xcode and Homebrew preinstalled
          - name: "Build and Publish Fractal FFmpeg on Linux Ubuntu"
            os: ubuntu-18.04

    env:
      windows-tar-name: fractal-windows-ffmpeg-static-lib.tar.gz
      windows-build-folder: Windows
      macos-tar-name: fractal-macos-ffmpeg-static-lib.tar.gz
      macos-build-folder: Darwin
      linux-tar-name: fractal-linux-ffmpeg-static-lib.tar.gz
      linux-build-folder: Linux
      headers-tar-name: fractal-ffmpeg-headers.tar.gz
      headers-build-folder: include
      s3-bucket-region: us-east-1
      s3-bucket-uri: s3://fractal-protocol-shared-libs

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will fail to push refs to dest repo

      - name: On Windows, Checkout Media Autobuild Suite
        if: runner.os == 'Windows'
        uses: actions/checkout@v2
        with:
          repository: m-ab-s/media-autobuild_suite
          token: ${{ secrets.GHA_PERSONAL_ACCESS_TOKEN }}

      # To publish FFmpeg builds to AWS S3
      - name: Configure AWS S3 CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_S3_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.s3-bucket-region }}

      ################################# MACOS STEPS START ###############################

      - name: On macOS, Explicitly Set Proper Homebrew Folder Permissions for Linking FFmpeg Dependencies
        if: runner.os == 'macOS'
        shell: bash
        run: |
          sudo chown -R `whoami`:admin /usr/local/bin
          sudo chown -R `whoami`:admin /usr/local/share
          sudo chown -R `whoami`:admin /usr/local/opt

      - name: On macOS, Install FFmpeg macOS Dependencies
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew install \
          automake fdk-aac git lame libass libtool libvorbis libvpx \
          opus sdl shtool texi2html theora wget x264 x265 xvid nasm

      # We disable commandline programs and SDL2 since we have our own SDL2 static build
      # macOS hardware acceleration libraries (Videotoolbox, Audiotoolbox) are enabled by default
      - name: On macOs, Configure and Make FFmpeg # only configure the minimum required flags for the Fractal protocol
        if: runner.os == 'macOS'
        shell: bash
        run: |
          ./configure \
          --prefix=/usr/local --enable-gpl --enable-nonfree --enable-version3 \
          --disable-programs --disable-doc --disable-debug \
          --enable-opengl --disable-sdl2 --enable-libfdk-aac --enable-libx264 --enable-libx265 \
          && make

      ################################# MACOS STEPS END #################################

      ################################# LINUX STEPS START ###############################

      - name: Build FFmpeg on Linux Ubuntu 18.04 through Docker
        if: runner.os == 'Linux'
        shell: bash
        run: ./docker-build.sh 18

      ################################# LINUX STEPS END #################################

      ################################ WINDOWS STEPS START ##############################

      # run this from cmd

      # 1- echo 3 to build for 64-bit systems
      # 2- echo 1 to build non-free dependencies
      # 3- echo 2 to NOT build standalone binaries for libraries included in FFmpeg
      # 4- echo 1 to NOT build VP8/9 encoder
      # 5- echo 1 to build aom
      # 6- echo 1 to build rav1e
      # 7- echo 1 to build dav1d
      # 8- echo 1 to build libavif
      # 9- echo 1 to build jpeg-xl
      # 10- echo 4 to build x264 with lib/binary with 8 and 10-bit, and libavformat and ffms2
      # 11- echo 1 to build x265 with lib/binary with Main, Main10 and Main12
      # 12- echo 1 to build Kvazaar (H.265 encoder)
      # 13- echo 1 to build SVT-HEVC (H.265 encoder)
      # 14- echo 2 to NOT build xvc (HEVC and AV1 competitor)
      # 15- echo 2 to NOT build Fraunhofer VVC (H.265 successor enc/decoder)
      # 16- echo 2 to NOT build SVT-AV1 (AV1 encoder)
      # 17- echo 2 to NOT build SVT-VP9 (VP9 encoder)
      # 18- echo 1 to build FLAC (Free Lossless Audio Codec)
      # 19- echo 1 to build FDK-AAC (AAC-LC/HE/HEv2 codec)
      # 20- echo 2 to NOT build FAAC (old, low-quality and non-free AAC-LC codec)
      # 21- echo 2 to NOT build exhale binary (open-source ISO/IEC 23003-3 USAC, xHE-AAC encoder)
      # 22- echo 2 to NOT build mediainfo binaries (Multimedia file information tool)
      # 23- echo 2 to NOT build sox binaries (Sound processing tool)
      # 24- echo 1 to build STATIC FFmpeg libraries
      # 25- echo 1 to "Always build FFmpeg when libraries have been updated" -- this is irrelevant here since GHA VMs are wiped after runs
      # 26- echo 1 to "Choose ffmpeg and mpv optional libraries"
      # 27- echo "c" to continue
      # 28- echo "c" to continue
      # 29- echo 2 to NOT build mp4box (mp4 muxer/toolbox)
      # 30- echo 2 to NOT build rtmpdump binaries (rtmp tools)
      # 31- echo 2 to NOT build static mplayer/mencoder (UNSUPPORTED)
      # 32- echo 1 to build mpv
      # 33- echo 2 to NOT build vlc
      # 34- echo 1 to build bmx
      # 35- echo 2 to NOT build static curl
      # 36- echo 2 to NOT build FFMedia Broadcast binary (UNSUPPORTED)
      # 37- echo 2 to NOT build cyanrip (CLI CD ripper)
      # 38- echo 2 to NOT build redshift (f.lux FOSS clone)
      # 39- echo 2 to NOT build ripgrep (faster grep in Rust)
      # 40- echo 2 to NOT build jq (CLI JSON processor)
      # 41- echo 2 to NOT build jo (CLI JSON from shell)
      # 42- echo 2 to NOT build dssim (multiscale SSIM in Rust)
      # 43- echo 1 to build avs2 (Audio Video Coding Standard Gen2 encoder/decoder)
      # 44- echo 2 to NOT using clang instead of gcc (Recommended)
      # 45- echo 2 to use 2 cores for compilation (GHA VMs have only 2 cores)
      # 46- echo 1 to delete versioned source folders after compile is done
      # 47- echo 1 to strip compiled files binaries
      # 48- echo 2 to NOT pack compiled files
      # 49- echo 1 to write logs of compilation commands
      # 50- echo 2 to NOT create script to update suite files automatically
      # 51- echo 1 to show timestamps of commands during compilation
      # 52- echo 2 to NOT use ccache when compiling
      # 53- echo 1 to disable mintty and print the output to this console
      # - name: Build FFmpeg on Windows through media-autobuild_suite.bat
      #   if: runner.os == 'Windows'
      #   shell: cmd
      #   run: |
      #     (
      #       echo 3
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 1
      #       echo 1
      #       echo 1
      #       echo 1
      #       echo 4
      #       echo 1
      #       echo 1
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 1
      #       echo 1
      #       echo c
      #       echo c
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 2
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 1
      #       echo 1
      #       echo 2
      #       echo 1
      #       echo 2
      #       echo 2
      #       echo 1) | .\media-autobuild_suite.bat

      ################################ WINDOWS STEPS END ################################

      - name: Tar FFmpeg Libs and Upload to AWS S3
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
              # create protocol-compliant lib folder and move libs over
              mkdir ${{ env.linux-build-folder }}
              mv docker-builds/* ${{ env.linux-build-folder }}/

              # tar and uplaod
              tar -zcvf ${{ env.linux-tar-name }} ${{ env.linux-build-folder }}
              aws s3 cp ${{ env.linux-tar-name }} ${{ env.s3-bucket-uri }}/${{ env.linux-tar-name }}
          elif [ "$RUNNER_OS" == "Windows" ]; then




              # tar -zcvf ${{ env.windows-tar-name }} SDL2-static.lib
              # aws s3 cp ${{ env.windows-tar-name }} ${{ env.s3-bucket-uri }}/${{ env.windows-tar-name }}



          else
              # create protocol-compliant lib folder and move libs over
              mkdir ${{ env.macos-build-folder }}
              mv libavcodec/libavcodec.a ${{ env.macos-build-folder }}/libavcodec.a
              mv libavdevice/libavdevice.a ${{ env.macos-build-folder }}/libavdevice.a
              mv libavfilter/libavfilter.a ${{ env.macos-build-folder }}/libavfilter.a
              mv libavformat/libavformat.a ${{ env.macos-build-folder }}/libavformat.a
              mv libavutil/libavutil.a ${{ env.macos-build-folder }}/libavutil.a
              mv libpostproc/libpostproc.a ${{ env.macos-build-folder }}/libpostproc.a
              mv libswresample/libswresample.a ${{ env.macos-build-folder }}/libswresample.a
              mv libswscale/libswscale.a ${{ env.macos-build-folder }}/libswscale.a

              # tar and uplaod
              tar -zcvf ${{ env.macos-tar-name }} ${{ env.macos-build-folder }}
              aws s3 cp ${{ env.macos-tar-name }} ${{ env.s3-bucket-uri }}/${{ env.macos-tar-name }}
          fi

      - name: Tar FFmpeg headers and Upload to AWS S3
        if: runner.os == 'Linux' # Only run once, as headers are identical on every OS
        shell: bash
        run: |
          # create protocol-compliant headers folder and subfolders
          mkdir ${{ env.headers-build-folder }}
          mkdir ${{ env.headers-build-folder }}/libavcodec
          mkdir ${{ env.headers-build-folder }}/libavdevice
          mkdir ${{ env.headers-build-folder }}/libavfilter
          mkdir ${{ env.headers-build-folder }}/libavformat
          mkdir ${{ env.headers-build-folder }}/libavutil
          mkdir ${{ env.headers-build-folder }}/libpostproc
          mkdir ${{ env.headers-build-folder }}/libswresample
          mkdir ${{ env.headers-build-folder }}/libswscale

          # move select header files over, only the ones needed
          # libavcodec
          mv libavcodec/ac3_parser.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/adts_parser.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/avcodec.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/avdct.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/avfft.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/d3d11va.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/dira.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/dv_profile.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/dxva2.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/jni.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/mediacodec.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/qsv.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/vaapi.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/vdpau.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/version.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/videotoolbox.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/vorbis_parser.h ${{ env.headers-build-folder }}/libavcodec/
          mv libavcodec/xvmc.h ${{ env.headers-build-folder }}/libavcodec/

          # libavdevice
          mv libavdevice/avdevice.h ${{ env.headers-build-folder }}/libavdevice/
          mv libavdevice/version.h ${{ env.headers-build-folder }}/libavdevice/

          # libavfilter
          mv libavfilter/avfilter.h ${{ env.headers-build-folder }}/libavfilter/
          mv libavfilter/buffersink.h ${{ env.headers-build-folder }}/libavfilter/
          mv libavfilter/buffersrc.h ${{ env.headers-build-folder }}/libavfilter/
          mv libavfilter/version.h ${{ env.headers-build-folder }}/libavfilter/

          # libavformat
          mv libavformat/avformat.h ${{ env.headers-build-folder }}/libavformat/
          mv libavformat/avio.h ${{ env.headers-build-folder }}/libavformat/
          mv libavformat/version.h ${{ env.headers-build-folder }}/libavformat/

          # libavutil
          mv libavutil/adler32.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/aes.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/aes_ctr.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/attributes.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/audio_fifo.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/avassert.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/avconfig.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/avstring.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/avutil.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/base64.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/blowfish.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/bprint.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/bswap.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/buffer.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/camellia.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/cast5.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/channel_layout.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/common.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/cpu.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/crc.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/des.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/dict.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/display.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/downmix_info.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/encryption_info.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/error.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/eval.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/ffversion.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/fifo.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/file.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/frame.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hash.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hdr_dynamic_metadata.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hmac.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_cuda.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_d3d11va.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_drm.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_dxva2.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_mediacodec.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_qsv.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_vaapi.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_vdpau.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/hwcontext_videotoolbox.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/imgutils.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/intfloat.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/intreadwrite.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/lfg.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/log.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/lzo.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/macros.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/mastering_display_metadata.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/mathematics.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/md5.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/mem.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/motion_vector.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/murmur3.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/opt.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/parseutils.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/pixdesc.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/pixelutils.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/pixfmt.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/random_seed.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/rational.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/rc4.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/replaygain.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/ripemd.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/samplefmt.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/sha.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/sha512.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/spherical.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/stereo3d.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/tea.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/threadmessage.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/time.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/timecode.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/timestamp.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/tree.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/twofish.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/tx.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/version.h ${{ env.headers-build-folder }}/libavutil/
          mv libavutil/xtea.h ${{ env.headers-build-folder }}/libavutil/

          # libpostproc
          mv libpostproc/postprocess.h ${{ env.headers-build-folder }}/libpostproc/
          mv libpostproc/version.h ${{ env.headers-build-folder }}/libpostproc/

          # libswresample
          mv libswresample/swresample.h ${{ env.headers-build-folder }}/libswresample/
          mv libswresample/version.h ${{ env.headers-build-folder }}/libswresample/

          # libswscale
          mv libswscale/swscale.h ${{ env.headers-build-folder }}/libswscale/
          mv libswscale/version.h ${{ env.headers-build-folder }}/libswscale/

          # tar and upload
          tar -zcvf ${{ env.headers-tar-name }} include
          aws s3 cp ${{ env.headers-tar-name }} ${{ env.s3-bucket-uri }}/${{ env.headers-tar-name }}

  notify-slack:
    name: Notify Slack
    needs: [build-and-publish-fractal-ffmpeg]
    if: success()
    runs-on: ubuntu-20.04

    steps:
      - name: Notify Slack
        run: |
          curl -X POST \
          --data-urlencode "payload={\"channel\": \"#alerts\", \"username\": \"Fractal Bot\", \"text\": \"Fractal FFmpeg Static Build Deployed to Production via Upload to AWS S3.\", \"icon_emoji\": \":fractal:\"}" \
          ${{ secrets.SLACK_HOOKS_ENDPOINT }}
